# Reusable deploy workflow for Docker Compose projects
# Call this from your project's workflow:
#
#   deploy:
#     needs: [test]
#     uses: nelsonblaha/nelnet-ci/.github/workflows/deploy.yml@main
#     with:
#       deploy_path: /home/ben/docker/my-project
#     secrets:
#       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Deploy

on:
  workflow_call:
    inputs:
      deploy_path:
        description: 'Path to deployment directory'
        required: true
        type: string
      compose_file:
        description: 'Docker compose file name'
        required: false
        default: 'docker-compose.yml'
        type: string
      pre_deploy_script:
        description: 'Optional script to run before docker compose'
        required: false
        type: string
    secrets:
      GITHUB_TOKEN:
        required: true

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Deploy to production
        env:
          DEPLOY_PATH: ${{ inputs.deploy_path }}
        run: |
          cd "$DEPLOY_PATH"

          # Mark directory as safe
          git config --global --add safe.directory "$DEPLOY_PATH"

          # Pull latest code
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git fetch origin ${{ github.ref_name }}
          git reset --hard origin/${{ github.ref_name }}

          # Restore SSH remote
          git remote set-url origin git@github.com:${{ github.repository }}.git

          # Run pre-deploy script if provided
          if [ -n "${{ inputs.pre_deploy_script }}" ]; then
            echo "Running pre-deploy script..."
            ${{ inputs.pre_deploy_script }}
          fi

          # Rebuild and restart containers
          docker compose -f ${{ inputs.compose_file }} down
          docker compose -f ${{ inputs.compose_file }} up -d --build
          echo "Deploy complete!"
