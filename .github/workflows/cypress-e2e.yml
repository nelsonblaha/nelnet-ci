# Reusable Cypress E2E workflow
# Call from your project:
#
#   e2e:
#     uses: nelsonblaha/nelnet-ci/.github/workflows/cypress-e2e.yml@main
#     with:
#       spec: 'cypress/e2e/*.cy.js'
#       start_command: 'cd app && python -m uvicorn main:app --port 5000'
#       base_url: 'http://localhost:5000'

name: Cypress E2E

on:
  workflow_call:
    inputs:
      node_version:
        description: 'Node.js version'
        required: false
        default: '20'
        type: string
      spec:
        description: 'Cypress spec pattern'
        required: false
        default: 'cypress/e2e/**/*.cy.js'
        type: string
      start_command:
        description: 'Command to start the application'
        required: true
        type: string
      base_url:
        description: 'Base URL for Cypress'
        required: false
        default: 'http://localhost:5000'
        type: string
      wait_on:
        description: 'URL to wait for before running tests'
        required: false
        default: ''
        type: string
      env_vars:
        description: 'JSON object of environment variables for app startup'
        required: false
        default: '{}'
        type: string
      cypress_env_vars:
        description: 'JSON object of Cypress environment variables (CYPRESS_ prefix)'
        required: false
        default: '{}'
        type: string
      setup_python:
        description: 'Set up Python for app (for Python backends)'
        required: false
        default: false
        type: boolean
      python_version:
        description: 'Python version if setup_python is true'
        required: false
        default: '3.11'
        type: string
      python_requirements:
        description: 'Python requirements file'
        required: false
        default: 'requirements.txt'
        type: string

jobs:
  cypress:
    runs-on: self-hosted
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Kill stale processes
        run: |
          for port in 5000 8100 9000; do
            fuser -k $port/tcp 2>/dev/null || true
            pid=$(lsof -t -i:$port 2>/dev/null || true)
            [ -n "$pid" ] && kill -9 $pid 2>/dev/null || true
          done
          sleep 2

      - name: Set up Python
        if: inputs.setup_python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install Python dependencies
        if: inputs.setup_python
        run: pip install -r ${{ inputs.python_requirements }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'

      - name: Install Cypress
        run: npm ci

      - name: Start application
        env: ${{ fromJson(inputs.env_vars) }}
        run: |
          ${{ inputs.start_command }} &
          sleep 5

      - name: Wait for application
        if: inputs.wait_on != ''
        run: |
          for i in $(seq 1 30); do
            if curl -s "${{ inputs.wait_on }}" > /dev/null; then
              echo "Application ready"
              exit 0
            fi
            sleep 2
          done
          echo "Application failed to start"
          exit 1

      - name: Run Cypress tests
        env: ${{ fromJson(inputs.cypress_env_vars) }}
        run: npx cypress run --spec "${{ inputs.spec }}"
        env:
          CYPRESS_BASE_URL: ${{ inputs.base_url }}

      - name: Stop application
        if: always()
        run: |
          pkill -f "uvicorn" || true
          pkill -f "sbt run" || true
