# Reusable Python pytest workflow
# Call from your project:
#
#   test:
#     uses: nelsonblaha/nelnet-ci/.github/workflows/python-pytest.yml@main
#     with:
#       python_version: '3.11'
#       test_path: 'tests/unit'
#       coverage_min: 50

name: Python Pytest

on:
  workflow_call:
    inputs:
      python_version:
        description: 'Python version'
        required: false
        default: '3.11'
        type: string
      test_path:
        description: 'Path to tests'
        required: false
        default: 'tests/'
        type: string
      requirements_file:
        description: 'Requirements file for test dependencies'
        required: false
        default: 'requirements-test.txt'
        type: string
      app_requirements_file:
        description: 'Requirements file for app dependencies'
        required: false
        default: 'requirements.txt'
        type: string
      coverage_min:
        description: 'Minimum coverage percentage (0 to disable)'
        required: false
        default: 0
        type: number
      working_directory:
        description: 'Working directory for pytest'
        required: false
        default: '.'
        type: string
      env_vars:
        description: 'JSON object of environment variables'
        required: false
        default: '{}'
        type: string

jobs:
  pytest:
    runs-on: self-hosted
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install dependencies
        run: |
          pip install -r ${{ inputs.app_requirements_file }}
          pip install -r ${{ inputs.requirements_file }}

      - name: Run pytest
        env: ${{ fromJson(inputs.env_vars) }}
        run: |
          COVERAGE_ARGS=""
          if [ "${{ inputs.coverage_min }}" -gt 0 ]; then
            COVERAGE_ARGS="--cov=. --cov-report=term-missing --cov-fail-under=${{ inputs.coverage_min }}"
          fi
          pytest ${{ inputs.test_path }} -v --tb=short $COVERAGE_ARGS
