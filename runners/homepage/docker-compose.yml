# GitHub Actions Self-Hosted Runners
# Runs 3 runners with health checks, auto-restart, and scaling support
#
# Setup:
# 1. Go to https://github.com/settings/tokens and create a PAT with 'repo' scope
# 2. Export GITHUB_PAT=your_token
# 3. docker-compose up -d --scale runner=3
#
# Sources:
# - https://github.com/myoung34/docker-github-actions-runner
# - https://github.com/myoung34/docker-github-actions-runner/wiki/Usage

services:
  runner:
    build: .
    image: github-runner-cypress:latest
    restart: unless-stopped
    environment:
      # For org-level runners (covers all repos):
      # - ORG_NAME=nelsonblaha
      # - RUNNER_SCOPE=org

      # For repo-specific runners:
      - REPO_URL=https://github.com/nelsonblaha/homepage
      - RUNNER_SCOPE=repo

      # Authentication (use ACCESS_TOKEN for auto-registration)
      - ACCESS_TOKEN=${GITHUB_PAT}

      # Runner naming - uses prefix + random suffix for uniqueness
      - RUNNER_NAME_PREFIX=nelnet
      - RANDOM_RUNNER_SUFFIX=true

      # Labels for targeting specific runners
      - LABELS=self-hosted,linux,x64,nelnet

      # Work directory (contained within container, no host mount needed)
      - RUNNER_WORKDIR=/tmp/github-runner

      # Ephemeral mode - runner restarts fresh after each job
      # Helps with cleanup and stuck runners
      - EPHEMERAL=true

      # Disable automatic updates (image handles it)
      - DISABLE_AUTO_UPDATE=true

    volumes:
      # Docker-in-docker support for docker commands in workflows
      - /var/run/docker.sock:/var/run/docker.sock

      # Persist runner data between restarts
      - runner-data:/home/runner

      # Mount production directory for deployments
      - /home/ben/docker/blaha-homepage:/home/ben/docker/blaha-homepage

    # Enable host.docker.internal for accessing host services
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Connect to CI shared network for container communication
    networks:
      - default
      - blaha-ci-shared

    # Health check - restart if runner becomes unhealthy
    healthcheck:
      test: ["CMD", "pgrep", "-f", "Runner.Listener"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  runner-data:

networks:
  blaha-ci-shared:
    external: true
